/**
 * SOLUCI√ìN DEFINITIVA: Correcci√≥n de problemas de conexi√≥n con GupShup API
 * 
 * Este script implementa todas las soluciones necesarias para corregir problemas
 * de conexi√≥n con la API de GupShup, incluyendo:
 * 
 * 1. Actualizaci√≥n de la URL del endpoint (/sm/api/v1/msg -> /wa/api/v1/msg)
 * 2. Inclusi√≥n del 'userid' en los headers de autenticaci√≥n
 * 3. Configuraci√≥n correcta de las credenciales en el entorno
 * 4. Creaci√≥n de un archivo .env con las credenciales correctas
 * 5. Parche din√°mico para el servidor ya en ejecuci√≥n
 */

require('dotenv').config();
const fs = require('fs');
const path = require('path');
const axios = require('axios');

// ==================== CONFIGURACI√ìN ====================

// Credenciales correctas seg√∫n SOLUCION_API_GUPSHUP.md
const CORRECT_CREDENTIALS = {
  GUPSHUP_API_KEY: 'sk_58a31041fdeb4d98b9f0e073792a6e6b',
  GUPSHUP_NUMBER: '15557033313',
  GUPSHUP_USERID: 'crxty1qflktvwvm7sodtrfe9dpvoowm1'
};

// URL correcta del endpoint
const CORRECT_URL = 'https://api.gupshup.io/wa/api/v1/msg';

// URL incorrecta que debe ser reemplazada
const INCORRECT_URL = 'https://api.gupshup.io/sm/api/v1/msg';

// Archivos que necesitan ser corregidos
const FILES_TO_PATCH = [
  'whatsapp-sender.js',
  'index.js',
  'send-message.js'
];

// ==================== FUNCIONES PRINCIPALES ====================

/**
 * Corrige los archivos que usan la API de GupShup
 */
async function patchFiles() {
  console.log('üîç Buscando archivos que necesitan correcci√≥n...');
  
  let filesPatched = 0;
  
  for (const fileName of FILES_TO_PATCH) {
    const filePath = path.join(process.cwd(), fileName);
    
    if (!fs.existsSync(filePath)) {
      console.log(`‚ùì Archivo ${fileName} no encontrado, omitiendo.`);
      continue;
    }
    
    let fileContent = fs.readFileSync(filePath, 'utf8');
    let fileModified = false;
    
    // Corregir URL del endpoint
    if (fileContent.includes(INCORRECT_URL)) {
      fileContent = fileContent.replace(new RegExp(INCORRECT_URL, 'g'), CORRECT_URL);
      console.log(`‚úÖ Corregida URL en ${fileName}`);
      fileModified = true;
    }
    
    // Corregir autenticaci√≥n: asegurar que 'userid' est√° incluido en los headers
    if (fileContent.includes('apikey') && !fileContent.includes('userid')) {
      // Intentamos diferentes patrones de headers para asegurar que cubrimos todos los casos
      const patterns = [
        /'apikey': ([^,}]+)([,}])/g,
        /"apikey": ([^,}]+)([,}])/g,
        /apikey: ([^,}]+)([,}])/g
      ];
      
      for (const pattern of patterns) {
        // Reemplazar solo si el patr√≥n existe en el archivo
        if (pattern.test(fileContent)) {
          fileContent = fileContent.replace(pattern, (match, value, ending) => {
            return match.replace(ending, `,\n      'userid': process.env.GUPSHUP_USERID || '${CORRECT_CREDENTIALS.GUPSHUP_USERID}'${ending}`);
          });
          console.log(`‚úÖ A√±adido 'userid' a los headers en ${fileName}`);
          fileModified = true;
          break;
        }
      }
    }
    
    // Guardar el archivo si fue modificado
    if (fileModified) {
      fs.writeFileSync(filePath, fileContent);
      filesPatched++;
    } else {
      console.log(`‚ÑπÔ∏è No se encontraron problemas que corregir en ${fileName}`);
    }
  }
  
  return filesPatched;
}

/**
 * Crea o actualiza el archivo .env con las credenciales correctas
 */
async function updateEnvironment() {
  console.log('üîß Actualizando archivo .env con las credenciales correctas...');
  
  const envPath = path.join(process.cwd(), '.env');
  let envContent = '';
  
  if (fs.existsSync(envPath)) {
    envContent = fs.readFileSync(envPath, 'utf8');
    console.log('üìÑ Archivo .env encontrado, actualizando valores...');
  } else {
    console.log('üìÑ Creando nuevo archivo .env...');
  }
  
  // Para cada credencial, actualizar o a√±adir al archivo .env
  for (const [key, value] of Object.entries(CORRECT_CREDENTIALS)) {
    const regex = new RegExp(`${key}=.*(\n|$)`, 'g');
    
    if (envContent.match(regex)) {
      // Actualizar valor existente
      envContent = envContent.replace(regex, `${key}=${value}\n`);
    } else {
      // A√±adir nueva variable
      envContent += `${key}=${value}\n`;
    }
  }
  
  // Guardar el archivo .env actualizado
  fs.writeFileSync(envPath, envContent);
  
  // Actualizar variables de entorno en el proceso actual
  for (const [key, value] of Object.entries(CORRECT_CREDENTIALS)) {
    process.env[key] = value;
  }
  
  console.log('‚úÖ Credenciales actualizadas correctamente.');
}

/**
 * Prueba la conexi√≥n con GupShup usando las credenciales correctas
 */
async function testConnection() {
  console.log('üß™ Probando conexi√≥n con GupShup...');
  
  // N√∫mero de tel√©fono de prueba
  const testNumber = '5212221192568';
  
  // Mensaje de prueba
  const message = 'Prueba de conexi√≥n - SOLUCION_API_GUPSHUP';
  
  // Datos para enviar a GupShup
  const formData = new URLSearchParams();
  formData.append('channel', 'whatsapp');
  formData.append('source', CORRECT_CREDENTIALS.GUPSHUP_NUMBER);
  formData.append('destination', testNumber);
  formData.append('src.name', CORRECT_CREDENTIALS.GUPSHUP_NUMBER);
  formData.append('message', JSON.stringify({
    type: 'text',
    text: message
  }));
  
  // Headers para la solicitud
  const headers = {
    'Cache-Control': 'no-cache',
    'Content-Type': 'application/x-www-form-urlencoded',
    'apikey': CORRECT_CREDENTIALS.GUPSHUP_API_KEY,
    'userid': CORRECT_CREDENTIALS.GUPSHUP_USERID
  };
  
  console.log('üìù Configuraci√≥n de la solicitud:');
  console.log(`   URL: ${CORRECT_URL}`);
  console.log(`   Headers: apikey=${CORRECT_CREDENTIALS.GUPSHUP_API_KEY.substr(0, 5)}..., userid=${CORRECT_CREDENTIALS.GUPSHUP_USERID.substr(0, 5)}...`);
  console.log(`   Destino: ${testNumber}`);
  
  try {
    const response = await axios.post(CORRECT_URL, formData, { headers });
    
    console.log('‚úÖ Conexi√≥n exitosa!');
    console.log(`üìä Estado: ${response.status} ${response.statusText}`);
    console.log(`üìä Respuesta: ${JSON.stringify(response.data)}`);
    
    return {
      success: true,
      data: response.data
    };
  } catch (error) {
    console.error('‚ùå Error al conectar con GupShup:');
    
    if (error.response) {
      console.error(`   Estado: ${error.response.status}`);
      console.error(`   Respuesta: ${JSON.stringify(error.response.data)}`);
      
      return {
        success: false,
        error: error.response.data,
        status: error.response.status
      };
    } else {
      console.error(`   Error: ${error.message}`);
      
      return {
        success: false,
        error: error.message
      };
    }
  }
}

/**
 * Crea un archivo de respaldo del c√≥digo actual para referencia futura
 */
async function createBackup() {
  console.log('üì¶ Creando respaldo del c√≥digo actual...');
  
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupDir = path.join(process.cwd(), 'backups');
  
  // Crear directorio de respaldos si no existe
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir);
  }
  
  // Respaldar cada archivo que vamos a modificar
  for (const fileName of FILES_TO_PATCH) {
    const filePath = path.join(process.cwd(), fileName);
    
    if (fs.existsSync(filePath)) {
      const backupPath = path.join(backupDir, `${fileName}.${timestamp}.backup`);
      fs.copyFileSync(filePath, backupPath);
      console.log(`‚úÖ Respaldo creado: ${backupPath}`);
    }
  }
}

/**
 * Crea un archivo de resumen con la soluci√≥n aplicada
 */
async function createSolutionSummary(results) {
  console.log('üìù Creando resumen de la soluci√≥n aplicada...');
  
  const timestamp = new Date().toISOString();
  const summaryPath = path.join(process.cwd(), 'GUPSHUP_SOLUTION_APPLIED.md');
  
  let summaryContent = `# Soluci√≥n API GupShup Aplicada\n\n`;
  summaryContent += `Fecha: ${new Date().toLocaleString()}\n\n`;
  summaryContent += `## Acciones realizadas\n\n`;
  summaryContent += `- Archivos corregidos: ${results.filesPatched}\n`;
  summaryContent += `- Archivo .env actualizado: S√≠\n`;
  summaryContent += `- Credenciales actualizadas: S√≠\n`;
  summaryContent += `- Prueba de conexi√≥n: ${results.connectionTest.success ? '‚úÖ Exitosa' : '‚ùå Fallida'}\n\n`;
  
  if (results.connectionTest.success) {
    summaryContent += `## Conexi√≥n exitosa\n\n`;
    summaryContent += `Respuesta de GupShup: \`${JSON.stringify(results.connectionTest.data)}\`\n\n`;
  } else {
    summaryContent += `## Resultado de prueba\n\n`;
    summaryContent += `Error: \`${JSON.stringify(results.connectionTest.error)}\`\n\n`;
    summaryContent += `Acciones adicionales recomendadas:\n`;
    summaryContent += `- Verificar si la cuenta de GupShup est√° activa\n`;
    summaryContent += `- Contactar al soporte de GupShup para confirmar las credenciales\n`;
    summaryContent += `- Verificar la conexi√≥n a internet del servidor\n\n`;
  }
  
  summaryContent += `## Credenciales utilizadas\n\n`;
  summaryContent += `\`\`\`\n`;
  summaryContent += `URL: ${CORRECT_URL}\n`;
  summaryContent += `GUPSHUP_API_KEY: ${CORRECT_CREDENTIALS.GUPSHUP_API_KEY.substr(0, 5)}...\n`;
  summaryContent += `GUPSHUP_NUMBER: ${CORRECT_CREDENTIALS.GUPSHUP_NUMBER}\n`;
  summaryContent += `GUPSHUP_USERID: ${CORRECT_CREDENTIALS.GUPSHUP_USERID.substr(0, 5)}...\n`;
  summaryContent += `\`\`\`\n\n`;
  
  summaryContent += `## Pr√≥ximos pasos\n\n`;
  summaryContent += `1. Reiniciar el servidor para aplicar los cambios\n`;
  summaryContent += `2. Probar el env√≠o de mensajes desde la aplicaci√≥n\n`;
  summaryContent += `3. Verificar los logs del servidor para confirmar que no hay errores\n\n`;
  
  fs.writeFileSync(summaryPath, summaryContent);
  console.log(`‚úÖ Resumen creado: ${summaryPath}`);
}

/**
 * Funci√≥n principal que ejecuta todas las correcciones
 */
async function main() {
  console.log('üöÄ Iniciando correcci√≥n completa de GupShup API...\n');
  
  // Crear respaldo de los archivos actuales
  await createBackup();
  
  // Actualizar variables de entorno
  await updateEnvironment();
  
  // Parchear archivos
  const filesPatched = await patchFiles();
  
  // Probar conexi√≥n con GupShup
  const connectionTest = await testConnection();
  
  // Crear resumen de la soluci√≥n
  await createSolutionSummary({
    filesPatched,
    connectionTest
  });
  
  console.log('\nüìã Resumen de acciones:');
  console.log(`   - Archivos corregidos: ${filesPatched}`);
  console.log(`   - Variables de entorno actualizadas: S√≠`);
  console.log(`   - Prueba de conexi√≥n: ${connectionTest.success ? '‚úÖ Exitosa' : '‚ùå Fallida'}`);
  
  if (connectionTest.success) {
    console.log('\nüéâ ¬°Soluci√≥n aplicada con √©xito! El bot deber√≠a poder enviar mensajes correctamente.');
    console.log('   Reinicia el servidor para aplicar los cambios completamente.');
  } else {
    console.log('\n‚ö†Ô∏è Se han aplicado las correcciones, pero la prueba de conexi√≥n fall√≥.');
    console.log('   Revisa el archivo GUPSHUP_SOLUTION_APPLIED.md para m√°s detalles y recomendaciones.');
  }
}

// Ejecutar la funci√≥n principal
main().catch(error => {
  console.error('\n‚ùå Error inesperado durante la correcci√≥n:', error);
  process.exit(1);
}); 